<dom-module id="ourrss-listen">
	<template>
		<style>
			:host @font-face {
				font-family: 'Material Icons';
				font-style: normal;
				font-weight: 400;
				src: url(https://example.com/MaterialIcons-Regular.eot);
				/* For IE6-8 */
				src: local('Material Icons'),
				local('MaterialIcons-Regular'),
				url(https://example.com/MaterialIcons-Regular.woff2) format('woff2'),
				url(https://example.com/MaterialIcons-Regular.woff) format('woff'),
				url(https://example.com/MaterialIcons-Regular.ttf) format('truetype');
			}

			:host .material-icons {
				font-family: 'Material Icons';
				font-weight: normal;
				font-style: normal;
				font-size: 24px;
				/* Preferred icon size */
				display: inline-block;
				line-height: 1;
				text-transform: none;
				letter-spacing: normal;
				word-wrap: normal;
				white-space: nowrap;
				direction: ltr;

				/* Support for all WebKit browsers. */
				-webkit-font-smoothing: antialiased;
				/* Support for Safari and Chrome. */
				text-rendering: optimizeLegibility;

				/* Support for Firefox. */
				-moz-osx-font-smoothing: grayscale;

				/* Support for IE. */
				font-feature-settings: 'liga';
			}


			:host {
				user-select: none;
				width: 100%;
				height: 100%;
			}

			:host ::-webkit-scrollbar {
				width: .5rem;
			}

			:host ::-webkit-scrollbar-thumb {
				border-radius: 1rem;
				-webkit-box-shadow: inset 0 0 6px #0288D1;
			}

			:host .grid-box {
				display: flex;
				flex-wrap: wrap;
				flex: 1;
			}

			:host .card:nth-child(n) {
				margin: .5rem;
			}

			/* @media (max-width: 450px) {
				:host ::-webkit-scrollbar {
					display: none;
				}
				:host ::-webkit-scrollbar-thumb {
					display: none;
				}
				:host .grid-box {
					display: grid;
					grid-gap: 1rem;
					padding: 1rem 1rem 6.5rem 1rem;
					grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				}
			} */

			/*:host .box:nth-child(even) {
				background-color: #EEE;
				color: #000;
			}*/

			:host .enc {

				transition: all 0.5s ease-in-out;
				font-size: 1rem;
				font-family: Ubuntu;
				border: 1pt solid #afe0f6;
				vertical-align: middle;
				color: slategrey;
				padding: 1rem 0rem 1rem 0rem;
			}

			:host .card {

				width: 10rem;
				height: 10rem;
				background-color: #FFF;
				color: #212121;
				font-size: 150%;
				text-align: center;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);

				transition: all 0.2s ease-in-out;

				cursor: pointer;
			}

			:host .card:hover {
				cursor: pointer;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.4), 0 6px 20px 0 rgba(0, 0, 0, 0.38);
			}

			:host .card-active {
				transition: all .1s ease-in-out;
				height: 100%;
				width: 100%;
				z-index: 90;
				margin-top: 6rem !important;
			}

			:host .card-body {
				transition: all 0.1s ease-in-out;
				text-align: center;
				height: 100%;
				width: auto;
				display: none;
			}

			:host .card-active>.card-body {
				text-align: center;
				margin-top: 2.5rem;
				height: 100%;
				width: auto;
				display: block;
			}


			:host .card-img {
				user-select: none;

				transition: all 0.5s ease-in-out;
				width: 10rem;
				height: 10rem;
			}

			:host .card-active>.card-img {

				transform: scale(1.2);
				margin-top: -11%;
				border-radius: 50%;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.4), 0 6px 20px 0 rgba(0, 0, 0, 0.38);
			}

			:host ul {
				-webkit-padding-start: 0rem;
				-webkit-margin-end: 0rem;
				list-style-type: none;
				display: none;
			}

			:host .card-active ul {
				display: block;
			}

			:host .card-actions {
				display: none;
				right: 0;
				padding: .5rem 1.5rem;
				position: absolute;
			}

			/* :host .card-active .card-actions {
				display: block;
				position: absolute;
			} */

			:host .card-icon {
				width: 2rem;
				height: 2rem;
			}




			/* The Modal (background) */

			:host .modal {

				transition: all 0.5s ease-in-out;

				background-color: #FFF;
				color: #212121;

				text-align: center;

				transition: all 0.2s ease-in-out;

				cursor: pointer;

				opacity: .4;
				display: none;
				/*  position: fixed; */
				z-index: 9999;
				overflow: auto;
				background: transparent;
			}

			:host .modal-active {

				display: flex;
				opacity: 1;
				/* position: fixed; */
				z-index: 9999;
				/* padding-top: 30%;
				
				left: 0;
				top: 0;
				width: 100%;*/
				overflow: auto;
				/* Enable scroll if needed 
				background-color: rgb(0, 0, 0);
				 Fallback color 
				background-color: rgba(0, 0, 0, 0.4);
				 Black w/ opacity */
			}

			/* Modal Content */

			:host .modal-content {

				background-color: #fefefe;
				margin: auto;
				padding: 20px;
				border: 1px solid #888;
				width: 80%;
			}

			/* The Close Button */

			:host .closeX {
				color: #aaaaaa;
				float: right;
				font-size: 28px;
				font-weight: bold;
			}

			:host .closeX:hover,
			:host .closeX:focus {
				color: #000;
				text-decoration: none;
				cursor: pointer;
			}

			:host button {
				/* background: rgb(56, 69, 77); */
				background: #0288D1;
				color: #B3E5FC;
				border: none;
				padding: 1rem;
				font-size: 1rem;
			}
		</style>


		<div id="gridBox" class="grid-box">


		</div>


		<!-- The Modal -->
		<div id="myModal" class="modal">

			<!-- Modal content -->
			<div class="modal-content">
				<span class="closeX">&times;</span>
				<p>Some text in the Modal..</p>
				<input id="newInput" placeholder="Audio Feed url" />
				<br/>
				<button class="close">Cancel</button>
				<button id="getter">Get Feed</button>

			</div>

		</div>

	</template>

	<script>
		const Store = require('electron-store')

		/*global HTMLElement navigator localStorage MediaMetadata*/
		class OurrssListen extends HTMLElement {

			init() {
				this.registerElements()
			}

			setProperties() {
				this.is = 'ourrss-listen'
			}

			// Fires when an instance was removed from the document.
			detachedCallback() {
				this.log('instance was removed.')
			}

			// Fires when an attribute was added, removed, or updated.
			attributeChangedCallback(attr, oldVal, newVal) {

				console.log(` ourrss-listen attr changed 
				 	-attr: ${attr}
				 	-oldVal: ${oldVal}
				 	-newVal:${newVal}
				 `)

				if (attr === 'addfeed') {
					
					if (newVal) {
						this.dom.modal.classList.add('modal-active')
						/* if (oldVal == true) {
							this.setAttribute('addFeed', false)
							this.dom.modal.classList.remove('modal-active')
						}
						else {

							this.dom.modal.classList.add('modal-active')
						} */
					}
					else if(newVal == false){
						this.dom.modal.classList.remove('modal-active')

					}

					Array.from(this.root.querySelectorAll(".close")).map(x => x.onclick = () => this.dom.modal.classList.remove('modal-active'))

					console.log('this.dom.modal via listen')
					console.log(this.dom.modal)

					//this.dom.newInput = this.root.querySelector('#newInput')
					//this.dom.getter = this.root.getElementById('getter')


					//this.dom.modal.style.display = "block";
					// When the user clicks on <span> (x), close the modal

					//this.dom.close.onclick = () => this.dom.modal.classList.remove('modal-active')





					// When the user clicks anywhere outside of the modal, close it
					//window.onclick = (e) => console.log(e.target)
					/* 
					window.onclick = function (event) {


						console.log(event.target.classList.contains('modal-content'))
						if (event.target.classList.contains('modal-content')) {

							console.log('WINDOW HIT')
							console.log(event.target)

							this.dom.modal.style.display = "none";

						}
					}.bind(this)
					*/
					//}.bind(this)

					//'src' == attr ? this.dom.audio.src = newVal : ''
				}
			}

			// Fires when an instance was inserted into the document.
			attachedCallback() {
				var template = this.owner.querySelector('template')
				var clone = document.importNode(template.content, true)
				this.root = this.createShadowRoot()
				this.root.appendChild(clone)
				this.init()
			}


			// Fires when an instance of the element is created.
			createdCallback() {
				this.setProperties()
				this.parseAttributes()

				// //console.log('instance was created.')
			}

			parseAttributes() {

				//this.name = this.getAttribute('name');

				//this.something = parseInt(this.getAttribute('something'));
			}

			registerElements() {

				this.dom = {}
				this.dom.gridBox = this.root.querySelector('.grid-box')
				this.dom.boxes = Array.from(this.root.children.gridBox.children)
				this.dom.cards = Array.from(this.root.querySelectorAll('.card'))
				this.dom.player = this.root.querySelector('ourrss-player')
				this.dom.modal = this.root.getElementById('myModal')

				this.addListeners()

			}

			addListeners() {


				this.ready()
			}

			ready() {

				const store = new Store();

				const audio = store.get('audio')
				if (!store.get('audio')) {
					const audio = {}
					audio.feeds = []
					store.set('audio', audio)
				} else {

					console.dir(audio)

					console.log(`ourrss-listen is ready. Making cards`)


					audio.feeds.map(x => {
						console.dir(audio)
						this.mkCard(x)
					})
				}
			}

			del(e) {
				if (!e) {
					console.log('NO EVENT')
					return false
				}
				e.preventDefault()
				e.cancelBubble()
				console.log(`delete hit`)
			}

			refresh() {
				console.log(`refresh hit`)
			}

			mkCard(feed) {

				let lines = ''

				feed.items.map(x => {
					if (x.enclosures) {

						lines +=
							`<li class="enc" data-name="${feed.title}" data-title="cast" data-audio="${x.enclosures[0].url}" >
								${x.title}<br/>${new Date(x.created).toDateString()}
							</li>`
					}
				});

				const card = document.createElement('div')
				card.classList.add('card')


				let delCont = document.createElement('div');
				delCont.innerHTML = '<i class="material-icons card-icon">delete</i>';

				let del = delCont.childNodes[0]
				del.onclick = this.del
				//Array.from(del.children).map(x => x.onclick = this.delete())

				card.innerHTML +=
					`<span class="card-actions">
						
					</span>
					<img draggable="false" class="card-img" src="${feed.image}"  />

					<div class="card-body">
						
						${feed.title}
						<ul>
							${lines}
						</ul>
					</div>
				`;

				card.onclick = (e) => {

					this.dom.cards.map(x => x.classList.remove('card-active'))

					let card = e.target
					console.dir(card)

					if (card.tagName.toLowerCase() === 'li') {
						console.log('was a li.enc click to play an episode')

						const elem = card
						card = card.parentElement.parentElement.parentElement
						const image = card.querySelector('.card-img')

						//card.parentElement.style.display = 'block'

						console.log('//todo use this.dom.player')
						console.log(this.dom.player)
						const PLAYER = e.path[9].querySelector('ourrss-player')
						PLAYER.setAttribute('image', image.src)
						PLAYER.setAttribute('src', elem.dataset.audio)
						PLAYER.setAttribute('name', elem.dataset.name)
						PLAYER.setAttribute('title', elem.dataset.title)
						PLAYER.setAttribute('play', true)


					}

					if (!card.classList.contains('card')) {
						card = e.target.parentElement
					}

					const img = card.querySelector('img')
					const body = card.querySelector('.card-body')

					if (card.classList.contains('card-active')) {

						card.classList.remove('card-active')

					} else {

						card.parentElement.prepend(card)
						setTimeout(() => card.classList.add('card-active'), 0)
					}


				}

				this.dom.gridBox.appendChild(card)
			}

		}

		if (document.createElement('ourrss-listen').constructor !== OurrssListen) {
			OurrssListen.prototype.owner = (document._currentScript || document.currentScript).ownerDocument;
			document.registerElement('ourrss-listen', OurrssListen);
		}

	</script>
</dom-module>