<dom-module id="ourrss-listen">
	<template>
		<style>
			@font-face {
				font-family: 'Material Icons';
				font-style: normal;
				font-weight: 400;
				src: url(https://example.com/MaterialIcons-Regular.eot);
			}

			:host .material-icons {
				font-family: 'Material Icons';
				font-weight: normal;
				font-style: normal;
				font-size: 24px;
				/* Preferred icon size */
				display: inline-block;
				line-height: 1;
				text-transform: none;
				letter-spacing: normal;
				word-wrap: normal;
				white-space: nowrap;
				direction: ltr;

				/* Support for all WebKit browsers. */
				-webkit-font-smoothing: antialiased;
				/* Support for Safari and Chrome. */
				text-rendering: optimizeLegibility;

				/* Support for Firefox. */
				-moz-osx-font-smoothing: grayscale;

				/* Support for IE. */
				font-feature-settings: 'liga';
			}


			:host {
				user-select: none;
				width: 100%;
				height: 100%;
			}

			:host ::-webkit-scrollbar {
				width: .5rem;
			}

			:host ::-webkit-scrollbar-thumb {
				border-radius: 1rem;
				box-shadow: inset 0 0 6px #0288D1;
			}

			:host .grid-box {
				display: flex;
				flex-wrap: wrap;
				flex: 1;
			}

			:host .card:nth-child(n) {
				margin: .5rem;
			}

			/* @media (max-width: 450px) {
				:host ::-webkit-scrollbar {
					display: none;
				}
				:host ::-webkit-scrollbar-thumb {
					display: none;
				}
				:host .grid-box {
					display: grid;
					grid-gap: 1rem;
					padding: 1rem 1rem 6.5rem 1rem;
					grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
				}
			} */

			/*:host .box:nth-child(even) {
				background-color: #EEE;
				color: #000;
			}*/

			:host .enc {
				transition: all 0.25s ease-in-out;
				font-family: 'Roboto', sans-serif;
				font-size: 1rem;
				border: 1pt solid #afe0f6;
				vertical-align: middle;
				color: slategrey;
				padding: 1rem 0rem 1rem 0rem;
			}

			:host .enc:hover {
				background: #bae7fc;
				color: #1b94d5;
				font-size: 1.1rem;
			}

			:host .card {

				width: 10rem;
				height: 10rem;
				background-color: #FFF;
				color: #212121;
				font-size: 150%;
				text-align: center;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);

				cursor: pointer;
			}

			:host .card:hover {
				cursor: pointer;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.4), 0 6px 20px 0 rgba(0, 0, 0, 0.38);
			}

			:host .card-active {
				transition: all .5s ease-in-out;
				height: 100%;
				width: 100%;
				z-index: 90;
				margin-top: 6rem !important;
				opacity: 1;
			}

			:host .card-body {
				transition: all 0.1s ease-in-out;
				text-align: center;
				height: 100%;
				width: auto;
				display: none;
			}

			:host .card-active>.card-body {
				text-align: center;
				margin-top: 2.5rem;
				height: 100%;
				width: auto;
				display: block;
			}


			:host .card-img {
				user-select: none;

				transition: all 0.5s ease-in-out;
				width: 10rem;
				height: 10rem;
			}

			:host .card-active>.card-img {

				transform: scale(1.2);
				margin-top: -11%;
				border-radius: 50%;
				box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.4), 0 6px 20px 0 rgba(0, 0, 0, 0.38);
			}

			:host ul {
				-webkit-padding-start: 0rem;
				-webkit-margin-end: 0rem;
				list-style-type: none;
				display: none;
			}

			:host .card-active ul {
				display: block;
			}

			:host .card-actions {
				right: 0;
				padding: .5rem 1.5rem;
				position: absolute;
				opacity: 0;
			}

			:host .card-active .card-actions {
				transition: all 0.25s ease-in-out;
				opacity: 1;
			}

			:host .card-icon {
				width: 2rem;
				height: 2rem;
			}

			:host button {
				background: #0288D1;
				color: #B3E5FC;
				border: none;
				padding: 1rem;
				font-size: 1rem;
			}

			:host .container {
				width: 98%;
				margin-left: 1%;
				height: auto;
				/* border: 1pt solid black; */
			}

			:host .gridContainer {
				width: 81%;
				margin: 0 auto;
				padding-bottom: 8rem;
				/* border: 1pt solid black; */
			}
		</style>

		<div class="container">
			<div class="gridContainer">
				<div id="gridBox" class="grid-box"></div>
			</div>
		</div>

	</template>

	<script>

		//const Util = require('./ourrss-util')
		const Store = require('electron-store')
		class OurrssListen extends HTMLElement {

			init() {
				this.registerElements()
			}

			setProperties() {
				this.is = 'ourrss-listen'
			}

			// Fires when an instance was removed from the document.
			detachedCallback() {
				console.log('instance was removed.')
			}

			// Fires when an attribute was added, removed, or updated.
			attributeChangedCallback(attr, oldVal, newVal) {

				console.log(` ourrss-listen attr changed 
				 	-attr: ${attr}
				 	-oldVal: ${oldVal}
				 	-newVal:${newVal}
				 `)

				if ('mk-card' === attr) {
					console.log(newVal, ' was passed in!')
					const feed = Util.getFeedByName(newVal)
					console.log('** newCast (listen')
					console.dir(feed)

					feed.then(x => this.mkCard(x))
					feed.catch(x => console.log(`Error: ${x}`))
				}
				else if('mk-all'){
					this.dom.gridBox.innerHTML = ''
					const store = new Store()
					const audio = store.get('audio')
					audio.feeds.map(x => this.mkCard(x))
					this.removeAttribute('mk-all')
				}

			}

			// Fires when an instance was inserted into the document.
			attachedCallback() {
				var template = this.owner.querySelector('template')
				var clone = document.importNode(template.content, true)
				this.root = this.createShadowRoot()
				this.root.appendChild(clone)
				this.init()
			}


			// Fires when an instance of the element is created.
			createdCallback() {
				this.setProperties()
				this.parseAttributes()

				// //console.log('instance was created.')
			}

			parseAttributes() {

				//this.name = this.getAttribute('name');

				//this.something = parseInt(this.getAttribute('something'));
			}

			registerElements() {

				this.dom = {}
				this.dom.container = this.root.querySelector('.gridContainer')
				this.dom.gridBox = this.root.querySelector('.grid-box')
				this.dom.cards = Array.from(this.root.querySelectorAll('.card'))
				this.dom.player = this.root.ownerDocument.querySelector('ourrss-player')

				this.addListeners()

			}

			addListeners() {

				this.ready()
			}

			ready() {

				const store = new Store();

				const audio = store.get('audio')
				if (!store.get('audio')) {
					const audio = {}
					audio.feeds = []
					store.set('audio', audio)
				} else {

					console.dir(audio)

					console.log(`ourrss-listen is ready. Making cards`)


					audio.feeds.map(x => {
						console.dir(audio)
						this.mkCard(x)
					})
				}
			}

			del(e) {
				if (!e) {
					console.log('NO EVENT')
					return false
				}
				e.preventDefault()
				e.cancelBubble()
				console.log(`delete hit`)
			}

			refresh() {
				console.log(`refresh hit`)
			}

			mkCard(feed) {

				let lines = ''

				feed.items.map(x => {
					if (x.enclosures) {

						lines +=
							`<li class="enc" data-name="${feed.title}" data-title="cast" data-audio="${x.enclosures[0].url}" >
								${x.title}<br/>${new Date(x.created).toDateString()}
							</li>`
					}
				});

				const card = document.createElement('div')
				card.classList.add('card')


				let delCont = document.createElement('div');
				delCont.innerHTML = '<i class="material-icons card-icon">delete</i>';

				let del = delCont.childNodes[0]
				del.onclick = this.del
				//Array.from(del.children).map(x => x.onclick = this.delete())

				card.innerHTML +=
					`<span class="card-actions">
						<svg class="refresh" style="width:24px;height:24px" viewBox="0 0 24 24">
							<path class="refresh" fill="#1b94d5" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" />
						</svg>
					</span>
					<img draggable="false" class="card-img" src="${feed.image}"  />

					<div class="card-body">
						${feed.title}
						<ul>
							${lines}
						</ul>
					</div>
				`;

				card.onclick = (e) => {
					
					const episode = e.target
					console.log(e.target)

					if (episode.classList.contains('card')) {

					}
					if (episode.classList.contains('refresh')) {

						const url = feed.feed

						const card = episode.parentElement.parentElement
						const ul = card.querySelector('ul')

						console.log(`Getting feed: ${url}`);
						ipc.send('getFeed', url);
						ipc.once('getFeedRes', (feed) => {

							console.log('//todo Make Card with ')
							console.dir(feed)
							/* feed.items.map(x => {
								if (x.enclosures) {

									lines +=
										`<li class="enc" data-name="${feed.title}" data-title="cast" data-audio="${x.enclosures[0].url}" >
											${x.title}<br/>${new Date(x.created).toDateString()}
										</li>`
								}
							}); */

						})
						return false;
					}

					this.dom.cards.map(x => x.classList.remove('card-active'))

					if (episode.tagName.toLowerCase() === 'li') {
						console.log('was a li.enc click to play an episode')

						const card = episode.parentElement.parentElement.parentElement
						const image = card.querySelector('.card-img')

						this.dom.player.setAttribute('image', image.src)
						this.dom.player.setAttribute('src', episode.dataset.audio)
						this.dom.player.setAttribute('name', episode.dataset.name)
						this.dom.player.setAttribute('title', episode.dataset.title)
						this.dom.player.setAttribute('play', true)


					}

					if (!card.classList.contains('card')) {
						card = e.target.parentElement
					}

					const img = card.querySelector('img')
					const body = card.querySelector('.card-body')

					if (card.classList.contains('card-active')) {

						this.dom.container.style.width = '81%'
						card.classList.remove('card-active')
						Array.from(this.root.querySelectorAll('.card')).map(x => x.style.opacity = 1)


					} else {

						this.dom.container.style.width = '100%'
						card.parentElement.prepend(card)
						card.classList.add('card-active')
						const cards = Array.from(this.root.querySelectorAll('.card')).filter(x => !x.classList.contains('card-active'))
						cards.map(x => x.style.opacity = 0)
					}

				}

				this.dom.gridBox.appendChild(card)
			}

		}

		if (document.createElement('ourrss-listen').constructor !== OurrssListen) {
			OurrssListen.prototype.owner = (document._currentScript || document.currentScript).ownerDocument;
			document.registerElement('ourrss-listen', OurrssListen);
		}

	</script>
</dom-module>